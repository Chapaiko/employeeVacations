<!DOCTYPE html>
<html>
    <head>
        <title>Vacation Calendar</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="aui/css/aui.min.css" media="all">
        <link rel="stylesheet" href="aui/css/aui-experimental.min.css" media="all">

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

        <script src="aui/js/aui.min.js"></script>
        <script src="aui/js/aui-experimental.min.js"></script>
        <script src="aui/js/aui-soy.min.js"></script>

        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    </head>
    <body>
        <div class="aui-page-header-actions">
            <div class="aui-buttons">
                <div class="tempo-pickers" >
                    <select id ="accountSelect" name="Account" class="aui-button aui-button-subtle aui-dropdown2-trigger" style="margin-left: 10px;">
                        <option>Account</option>
                    </select>

                    <select id ="departmentSelect" name="Department" class="aui-button aui-button-subtle aui-dropdown2-trigger" style="margin-left: 10px;" >
                        <option>Department</option>
                    </select>

                    <input type="text" name="Name" value="" size="25" class="aui-" placeholder="Name" style="margin-left: 10px;" />
                    <input type="button" value="Filter" name="filter" class="aui-button" style="margin-left: 10px;" />
                </div>
            </div>
        </div>
        <div class="aui-buttons" style="width: 100%">  
            <button name="filter" class="aui-button" style="margin-left: 10px;" onclick="changeTimePeriod(31)" >Show 1 month</button>
            <button name="filter" class="aui-button" style="margin-left: 10px;" onclick="changeTimePeriod(81)" >Show 3 months</button>
            <button name="filter" class="aui-button" style="margin-left: 10px;" onclick="changeTimePeriod(162)" >Show 6 months</button>

            <button name="filter" class="aui-button" style="margin-right: 10px; float: right" onclick="shiftDate(28 * 86400000)" > > </button>            
            <button name="filter" class="aui-button" style="margin-right: 10px; float: right" onclick="shiftDate(-28 * 86400000)" > < </button>
        </div>
        <div id="vacationContainer" style="height:500px ;" >

        </div>

        <script >
            class UsageOptions {
                constructor(resetOn, availableDays, totalDays) {
                    this._resetOn = resetOn;
                    this._availableDays = availableDays;
                    this._totalDays = totalDays;
                }
            }
            class Vacation {
                constructor(name, employee, description, vacationStart, vacationEnd, resolution) {
                    this._name = name;
                    this._employee = employee;
                    this._description = description;
                    this._vacationStart = new Date(vacationStart);
                    this._vacationEnd = new Date(vacationEnd);
                    this._resolution = resolution;
                }
            }

            class EmployeeWithVacations {
                constructor(name) {
                    this._vacations = new Set();
                    this._name = name;
                }

                addVacation(addedVacation) {
                    this._vacations.add(addedVacation);
                }
            }

            var currentUsageOptions = new UsageOptions();
            var employeeArray = new Array();
            var employeesWithVacationsArray = new Array();
            var inputData = new Object();
            var vacationsList = [];
            var scopedVacationList = [];
            var account;
            var department;
            var name;
            var minDate;
            var maxDate;
            var timePeriod = 28 * 86400000;
            var startListDate = new Date();
            var endListDate = new Date();
            function getJSONData() {
                $.getJSON("data/vacation.json", function (json) {
                    inputData = json;
                    console.log(inputData);
                    currentUsageOptions = new UsageOptions(new Date(inputData.usage.resetOn), inputData.usage.availableDays, inputData.usage.totalDays);
                    console.log(currentUsageOptions);
                    manageVacations();
                });
            }

            function shiftDate(dateShiftValue) {
                startListDate.setTime(Date.parse(startListDate) + dateShiftValue);
                startListDate = new Date(startListDate.getFullYear(), startListDate.getMonth(), startListDate.getDate());
                endListDate = new Date();
                endListDate.setTime(Date.parse(startListDate) + timePeriod);
                console.log('endListDate: ' + endListDate);
                scopedVacationList = [];
                manageScopeData();
                google.charts.load('current', {'packages': ['timeline']});
                google.charts.setOnLoadCallback(drawChart);
            }

            function changeTimePeriod(newTimePeriod) {
                timePeriod = newTimePeriod * 86400000;
                console.log('timePeriod: ' + timePeriod);
                startListDate = new Date(startListDate.getFullYear(), startListDate.getMonth(), startListDate.getDate());
                endListDate.setTime(Date.parse(startListDate) + timePeriod);
                scopedVacationList = [];
                manageScopeData();
                google.charts.load('current', {'packages': ['timeline']});
                google.charts.setOnLoadCallback(drawChart);
            }

            function setCurrentDates() {
                startListDate = new Date();
                startListDate = new Date(startListDate.getFullYear(), startListDate.getMonth(), startListDate.getDate());
                endListDate = new Date()
                endListDate.setTime(Date.parse(startListDate) + timePeriod);
                console.log('endListDate: ' + endListDate);
            }

            function manageVacations() {
                for (var i in inputData.calendar) {
                    let tempVac = new Vacation(
                            inputData.calendar[i].Name,
                            inputData.calendar[i].Employee,
                            inputData.calendar[i].Description,
                            new Date(inputData.calendar[i].VacationStart),
                            new Date(inputData.calendar[i].VacationEnd),
                            inputData.calendar[i].Resolution);
                    tempVac._vacationStart = new Date(tempVac._vacationStart.getFullYear(), tempVac._vacationStart.getMonth(), tempVac._vacationStart.getDate());
                    tempVac._vacationEnd = new Date(tempVac._vacationEnd.getFullYear(), tempVac._vacationEnd.getMonth(), tempVac._vacationEnd.getDate(), 23);
                    vacationsList.push(tempVac);
                }
                vacationsList.sort(compare);
                manageScopeData();
            }


            function compare(a, b) {
                if (a._employee < b._employee)
                    return -1;
                if (a._employee > b._employee)
                    return 1;
                return 0;
            }

            function manageScopeData() {
                var tempVacation = new Vacation();
                for (var emp in vacationsList) {
                    if ((vacationsList[emp]._vacationEnd >= startListDate && vacationsList[emp]._vacationStart <= endListDate)) {
                        tempVacation = new Vacation(
                                vacationsList[emp]._name,
                                vacationsList[emp]._employee,
                                vacationsList[emp]._description,
                                vacationsList[emp]._vacationStart,
                                vacationsList[emp]._vacationEnd,
                                vacationsList[emp]._resolution);
                        if (tempVacation._vacationStart < startListDate) {
                            tempVacation._vacationStart = startListDate;
                        }
                        if (tempVacation._vacationEnd > endListDate) {
                            tempVacation._vacationEnd = endListDate;
                        }
                        scopedVacationList.push(tempVacation);
                    }
                }
            }

            function drawChart() {
                var colorMap = new Map();
                colorMap.set('In Review', 'yellow');
                colorMap.set('Approved', 'green');
                var container = document.getElementById('vacationContainer');
                var chart = new google.visualization.Timeline(container);
                var dataTable = new google.visualization.DataTable();
                dataTable.addColumn({type: 'string', id: 'Employee'});
                dataTable.addColumn({type: 'string', id: 'Resolution'});
                dataTable.addColumn({type: 'string', role: 'style'});
                dataTable.addColumn({type: 'string', role: 'tooltip'});
                dataTable.addColumn({type: 'date', id: 'Start'});
                dataTable.addColumn({type: 'date', id: 'End'});
                for (var emp in scopedVacationList) {
                    dataTable.addRow([
                        scopedVacationList[emp]._employee,
                        scopedVacationList[emp]._resolution,
                        colorMap.get(scopedVacationList[emp]._resolution),
                        scopedVacationList[emp]._name + ' ' + scopedVacationList[emp]._description,
                        scopedVacationList[emp]._vacationStart,
                        scopedVacationList[emp]._vacationEnd
                    ]);
                }

                var tempMaxDate = new Date(currentUsageOptions._resetOn);
                tempMaxDate.setDate(tempMaxDate.getDate() + currentUsageOptions._totalDays);
                var options = {
                    timeline: {
                        //                       showBarLabels: false,
                        showRowLabels: true,
                        groupByRowLabel: true},
                    hAxis: {
                        minValue: startListDate,
                        maxValue: endListDate
                    }

                };
                $(window).resize(drawChart);
                var view = new google.visualization.DataView(dataTable);
                //var view = new google.visualization.DataView(dataTable);
                chart.draw(view, options);
            }

            window.onload = function () {
                getJSONData();
                setCurrentDates();
                google.charts.load('current', {'packages': ['timeline']});
                google.charts.setOnLoadCallback(drawChart);
            }
        </script>
    </body>
</html>
